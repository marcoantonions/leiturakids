<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/png" href="img/ancora.png">
    <link rel="stylesheet" type="text/css" href="style_home.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="script_home.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Leitura Kids</title>
</head>

<body>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://dnphjoqmkvnjueiwjayu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRucGhqb3Fta3ZuanVlaXdqYXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjE3ODEsImV4cCI6MjA3MzUzNzc4MX0.r8-M9EZg73sIrwESfd61hyGITsEwv_TJFZOBYeXk3d8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===============================
        // CARREGA NOME DO USUÁRIO
        // ===============================
        async function carregarNomeUsuario() {
            const usuarioId = localStorage.getItem('usuarioId');
            if (!usuarioId) return;

            const { data, error } = await supabase
                .from('usuarios')
                .select('nome')
                .eq('id', usuarioId)
                .single();

            if (error) {
                console.error('Erro ao buscar usuário:', error.message);
            } else if (data) {
                document.querySelector('.profile-name').textContent = data.nome;
            }
        }

        // ===============================
        // CRIA PROGRESSO INICIAL (se não existir)
        // ===============================
        async function inicializarProgresso() {
            console.log("Função inicializarProgresso chamada!");
            const usuarioId = localStorage.getItem('usuarioId');
            console.log("Usuário ID:", usuarioId);
            if (!usuarioId) return;

            // Verifica se já existe um progresso
            const { data: progressoExistente, error: selectError } = await supabase
                .from('progresso')
                .select('id')
                .eq('user_id', usuarioId)
                .maybeSingle();

            if (selectError) {
                console.error('Erro ao verificar progresso:', selectError.message);
                return;
            }

            // Se não existir, cria o progresso inicial
            if (!progressoExistente) {
                const { data: insertData, error: insertError } = await supabase
                    .from('progresso')
                    .insert([
                        {
                            user_id: usuarioId,
                            jogos_concluidos: 0,
                            pontos: 0,
                            atividades_concluidas: 0,
                            numero_conquistas: 0,
                            nivel_usuario: 1
                        }
                    ])
                    .select(); 

                if (insertError) {
                    console.error('Erro ao criar progresso:', insertError);
                } else {
                    console.log('Progresso inicial criado com sucesso:', insertData);
                }
            } else {
                console.log('Progresso já existente.');
            }

            carregarProgresso();
        }

        // ===============================
        // ATUALIZA BARRAS DE PROGRESSO
        // ===============================
        function atualizarBarrasProgresso(data) {
            // Constantes de progresso máximo
            const MAX_PONTOS = 2000;
            const MAX_ATIVIDADES = 120;
            const MAX_JOGOS = 100;
            const MAX_CONQUISTAS = 15;

            // Calcula percentuais
            const progressoAprendizado = Math.min((data.pontos / MAX_PONTOS) * 100, 100);
            const progressoAtividades = Math.min((data.atividades_concluidas / MAX_ATIVIDADES) * 100, 100);
            const progressoJogos = Math.min((data.jogos_concluidos / MAX_JOGOS) * 100, 100);
            const progressoConquistas = Math.min((data.numero_conquistas / MAX_CONQUISTAS) * 100, 100);

            // Atualiza as barras e labels
            atualizarBarra(0, progressoAprendizado);
            atualizarBarra(1, progressoAtividades);
            atualizarBarra(2, progressoJogos);
            atualizarBarra(3, progressoConquistas);
        }

        function atualizarBarra(index, percentual) {
            const barras = document.querySelectorAll('.progress-item');
            
            if (barras[index]) {
                const barraItem = barras[index];
                const fill = barraItem.querySelector('.progress-fill');
                const label = barraItem.querySelector('.progress-label span:last-child');

                // Arredonda o percentual
                const percentualArredondado = Math.round(percentual);

                // Atualiza a barra e o texto
                if (fill) {
                    fill.style.width = percentualArredondado + '%';
                    fill.setAttribute('data-progress', percentualArredondado);
                }
                
                if (label) {
                    label.textContent = percentualArredondado + '%';
                }
            }
        }

        // ===============================
        // MOSTRA OS DADOS NA TELA
        // ===============================
        async function carregarProgresso() {
            const usuarioId = localStorage.getItem('usuarioId');
            if (!usuarioId) return;

            const { data, error } = await supabase
                .from('progresso')
                .select('*')
                .eq('user_id', usuarioId)
                .single();

            if (error) {
                console.error('Erro ao carregar progresso:', error.message);
                return;
            }

            // Atualiza os elementos do HTML
            document.getElementById('jogos_concluidos').textContent = data.jogos_concluidos;
            document.getElementById('pontos').textContent = data.pontos;
            document.getElementById('atividades_concluidas').textContent = data.atividades_concluidas;
            document.getElementById('numero_conquistas').textContent = data.numero_conquistas;
            document.getElementById('nivel_usuario').textContent = `Nível ${data.nivel_usuario} - Leitor Iniciante`;
            
            // Atualiza as barras de progresso
            atualizarBarrasProgresso(data);
        }

        // ===============================
        // EXECUTA AO CARREGAR A PÁGINA
        // ===============================
        carregarNomeUsuario();
        inicializarProgresso();
    </script>


    <!-- Notificação -->
    <div class="notification" id="notification">
        Bem-vindo ao Leitura Kids! 
    </div>

    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="home.html" class="logo">LeituraKids</a>
            <nav>

                <div class="dropdown">
                    <button onclick="toggleMenu()" class="btn btn-gray">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <div id="menuDropdown" class="dropdown-content">
                        <a href="index.html#contact">Ajuda</a>
                        <a href="index.html">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
        </div>
    </header>

    <!-- Menu Vertical -->
    <nav class="side-nav">
        <div class="side-nav-item active" onclick="window.location.href='home.html'" title="Perfil">
            <img src="img/casa.png" alt="Perfil">
        </div>
        <div class="side-nav-item" onclick="window.location.href='aulas.html'" title="Aulas">
            <img src="img/livro.png" alt="Aulas">
        </div>
        <div class="side-nav-item" onclick="window.location.href='atividades.html'" title="Atividades">
            <img src="img/lapis.png" alt="Atividades">
        </div>
        <div class="side-nav-item" onclick="window.location.href='mapa.html'" title="Mapa">
            <img src="img/mapa.png" alt="Mapa">
        </div>
        <div class="side-nav-item" onclick="window.location.href='jogos.html'" title="Jogos">
            <img src="img/controle.png" alt="Jogos">
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="profile-container">
            <!-- Cabeçalho do Perfil -->
            <div class="profile-header">
                <div class="profile-avatar">🧒</div>
                <h1 class="profile-name">Nome</h1>
                <div class="profile-level" id="nivel_usuario">Nível 1 - Leitor Iniciante</div>
            </div>

            <!-- Estatísticas -->
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/estrela.png" alt="Pontos" /></div>
                    <div class="stat-number" id="pontos">0</div>
                    <div class="stat-label">Pontos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/lapis.png" alt="Sequência" /></div>
                    <div class="stat-number" id="atividades_concluidas">0</div>
                    <div class="stat-label">Atividades Concluídas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/controle.png" alt="Livros" /></div>
                    <div class="stat-number" id="jogos_concluidos">0</div>
                    <div class="stat-label">Jogos Concluídos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/trofeu.png" alt="Conquistas" /></div>
                    <div class="stat-number" id="numero_conquistas">0</div>
                    <div class="stat-label">Conquistas</div>
                </div>
            </div>

            <!-- Progresso -->
            <div class="progress-section">
                <h2 class="progress-title">Seu Progresso</h2>

                <div class="progress-item">
                    <div class="progress-label">
                        <span>Aprendizado</span>
                        <span>0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-progress="0" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-label">
                        <span>Atividades</span>
                        <span>0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-progress="0" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-label">
                        <span>Jogos</span>
                        <span>0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-progress="0" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-label">
                        <span>Troféis Conquistados</span>
                        <span>0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-progress="0" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

        <!-- Conteúdo Conquistas -->
        <main class="main-content">
            <!-- Cabeçalho das Conquistas -->
            <div class="conquistas-header">
                <h1>🏆 Suas Conquistas 🏆</h1>
                <p>Continue aprendendo e colete todas as medalhas especiais!</p>
            </div>

            <!-- Estatísticas das Conquistas -->
            <div class="conquistas-stats">
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/medalha.png" alt="Conquistas" /></div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">Conquistadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/cadeado.png" alt="Bloqueado" /></div>
                    <div class="stat-number">15</div>
                    <div class="stat-label">Bloqueadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/estrela.png" alt="Estrela" /></div>
                    <div class="stat-number">0%</div>
                    <div class="stat-label">Completado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon"><img src="img/alvo.png" alt="Alvo" /></div>
                    <div class="stat-number">3</div>
                    <div class="stat-label">Próximas</div>
                </div>
            </div>

            <!-- Categorias de Conquistas -->
            <div class="badges-categories">
                <!-- Alfabeto -->
                <div class="category-section">
                    <h2 class="category-title">
                        🔤 Conquistas Recentes
                    </h2>
                    <p class="category-description">Medalhas por aprender as letras e seus sons</p>
                    <div class="badges-grid">
                        <div class="badge new"
                            onclick="showBadgeDetail('Colecionador', '📚', 'Você já conhece muitas palavras!', 'Conquistado hoje!')">
                            <div class="badge-icon icon"><img src="img/livro.png" alt="Palavras" /></div>
                            <div class="badge-name">Colecionador</div>
                            <div class="badge-description">Aprenda 50 palavras</div>
                        </div>
                        <div class="badge"
                            onclick="showBadgeDetail('Primeira Letra', '🔤', 'Parabéns! Você aprendeu sua primeira letra!', 'Conquistado em 15/08/2024')">
                            <div class="badge-icon icon"><img src="img/abc.png" alt="Alfabeto" /></div>
                            <div class="badge-name">Primeira Letra</div>
                            <div class="badge-description">Aprenda sua primeira letra</div>
                        </div>
                        <div class="badges-grid">
                            <div class="badge"
                                onclick="showBadgeDetail('Semana Completa', '🔥', 'Você é muito dedicado! Parabéns!', 'Conquistado em 26/08/2024')">
                                <div class="badge-icon icon"><img src="img/fogo.png" alt="Sequência" /></div>
                                <div class="badge-name">Semana Completa</div>
                                <div class="badge-description">7 dias seguidos praticando</div>
                            </div>
                        </div>
                        <div class="badge"
                            onclick="showBadgeDetail('Quebra-Cabeça', '🧩', 'Você é expert em quebra-cabeças!', 'Conquistado em 24/08/2024')">
                            <div class="badge-icon icon"><img src="img/quebracabeca.png" alt="Quebra-Cabeça" /></div>
                            <div class="badge-name">Quebra-Cabeça</div>
                            <div class="badge-description">Complete 5 quebra-cabeças</div>
                        </div>
                    </div>
                    <div class="button-container">
                        <button class="back-button" onclick="location.href='conquistas.html'">Ver Todas</button>
                    </div>
                </div>
            </div>
        </main>
        <a href="#" class="ancora">
            <span class="material-symbols-outlined">anchor</span>
        </a>
</body>

</html>