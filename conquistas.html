<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/png" href="img/ancora.png">
    <link rel="stylesheet" type="text/css" href="style_conquistas.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="script_conquistas.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Leitura Kids - Conquistas</title>
</head>

<body>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://dnphjoqmkvnjueiwjayu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRucGhqb3Fta3ZuanVlaXdqYXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjE3ODEsImV4cCI6MjA3MzUzNzc4MX0.r8-M9EZg73sIrwESfd61hyGITsEwv_TJFZOBYeXk3d8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===============================
        // SISTEMA DE CONQUISTAS
        // ===============================
        const CONQUISTAS = {
            pontos: [
                {
                    id: 'leitor_iniciante_pontos',
                    nome: 'Leitor Iniciante',
                    descricao: 'Crie sua conta',
                    icone: 'livro-leitura.png',
                    requisito: 0,
                    tipo: 'pontos'
                },
                {
                    id: 'explorador_historias',
                    nome: 'Explorador de Hist√≥rias',
                    descricao: 'Consiga 500 pontos',
                    icone: 'mapa.png',
                    requisito: 500,
                    tipo: 'pontos'
                },
                {
                    id: 'mestre_livros',
                    nome: 'Mestre dos Livros',
                    descricao: 'Fa√ßa 1000 pontos',
                    icone: 'livro-biblioteca.png',
                    requisito: 1000,
                    tipo: 'pontos'
                },
                {
                    id: 'sabio_leitura',
                    nome: 'S√°bio da Leitura',
                    descricao: 'Alcance 2000 pontos',
                    icone: 'raio.png',
                    requisito: 2000,
                    tipo: 'pontos'
                }
            ],
            atividades: [
                {
                    id: 'leitor_iniciante_ativ',
                    nome: 'Leitor Iniciante',
                    descricao: 'Conclua 30 atividades',
                    icone: 'livro-leitura.png',
                    requisito: 30,
                    tipo: 'atividades'
                },
                {
                    id: 'explorador_ativ',
                    nome: 'Explorador',
                    descricao: 'Conclua 60 atividades',
                    icone: 'mapa.png',
                    requisito: 60,
                    tipo: 'atividades'
                },
                {
                    id: 'bibliotecario',
                    nome: 'Bibliotec√°rio',
                    descricao: 'Conclua 90 atividades',
                    icone: 'livro-biblioteca.png',
                    requisito: 90,
                    tipo: 'atividades'
                },
                {
                    id: 'monge_leitura',
                    nome: 'Monge da leitura',
                    descricao: 'Conclua 120 atividades',
                    icone: 'raio.png',
                    requisito: 120,
                    tipo: 'atividades'
                }
            ],
            jogos: [
                {
                    id: 'pequeno_amador',
                    nome: 'Pequeno Amador',
                    descricao: 'Jogue 30 jogos',
                    icone: 'cerebro.png',
                    requisito: 30,
                    tipo: 'jogos'
                },
                {
                    id: 'mago_jogos',
                    nome: 'Mago dos Jogos',
                    descricao: 'Jogue 60 jogos',
                    icone: 'quebracabeca.png',
                    requisito: 60,
                    tipo: 'jogos'
                },
                {
                    id: 'gigante_games',
                    nome: 'Gigante dos Games',
                    descricao: 'Jogue 80 jogos',
                    icone: 'corredor.png',
                    requisito: 80,
                    tipo: 'jogos'
                },
                {
                    id: 'rei_diversao',
                    nome: 'Rei da Divers√£o',
                    descricao: 'Jogue 100 jogos',
                    icone: 'alvo.png',
                    requisito: 100,
                    tipo: 'jogos'
                }
            ]
        };

        function atualizarConquistas(progresso) {
            console.log('üèÜ Atualizando todas as conquistas:', progresso);
            
            let totalConquistasDesbloqueadas = 0;
            let totalConquistas = 0;

            // Atualiza conquistas de pontos
            const gridPontos = document.querySelector('.category-section:nth-child(1) .badges-grid');
            if (gridPontos) {
                gridPontos.innerHTML = '';
                CONQUISTAS.pontos.forEach(conquista => {
                    totalConquistas++;
                    const desbloqueada = progresso.pontos >= conquista.requisito;
                    if (desbloqueada) totalConquistasDesbloqueadas++;
                    gridPontos.appendChild(criarBadge(conquista, desbloqueada));
                });
            }

            // Atualiza conquistas de atividades
            const gridAtividades = document.querySelector('.category-section:nth-child(2) .badges-grid');
            if (gridAtividades) {
                gridAtividades.innerHTML = '';
                CONQUISTAS.atividades.forEach(conquista => {
                    totalConquistas++;
                    const desbloqueada = progresso.atividades_concluidas >= conquista.requisito;
                    if (desbloqueada) totalConquistasDesbloqueadas++;
                    gridAtividades.appendChild(criarBadge(conquista, desbloqueada));
                });
            }

            // Atualiza conquistas de jogos
            const gridJogos = document.querySelector('.category-section:nth-child(3) .badges-grid');
            if (gridJogos) {
                gridJogos.innerHTML = '';
                CONQUISTAS.jogos.forEach(conquista => {
                    totalConquistas++;
                    const desbloqueada = progresso.jogos_concluidos >= conquista.requisito;
                    if (desbloqueada) totalConquistasDesbloqueadas++;
                    gridJogos.appendChild(criarBadge(conquista, desbloqueada));
                });
            }

            // Atualiza estat√≠sticas
            atualizarEstatisticas(totalConquistasDesbloqueadas, totalConquistas, progresso);
            
            console.log('‚úÖ Conquistas atualizadas:', totalConquistasDesbloqueadas, 'de', totalConquistas);
        }

        function criarBadge(conquista, desbloqueada) {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = desbloqueada ? 'badge unlocked' : 'badge locked';
            
            badgeDiv.innerHTML = `
                <div class="stat-icon icon">
                    <img src="img/${conquista.icone}" alt="${conquista.nome}"/>
                </div>
                <div class="badge-name">${conquista.nome}</div>
                <div class="badge-description">${conquista.descricao}</div>
            `;

            return badgeDiv;
        }

        function atualizarEstatisticas(desbloqueadas, total, progresso) {
            const bloqueadas = total - desbloqueadas;
            const percentualCompleto = ((desbloqueadas / total) * 100).toFixed(1);
            
            // Calcula pr√≥ximas conquistas (conquistas que faltam pouco para desbloquear)
            let proximas = 0;
            
            // Verifica conquistas de pontos
            CONQUISTAS.pontos.forEach(c => {
                if (progresso.pontos < c.requisito && progresso.pontos >= c.requisito * 0.7) {
                    proximas++;
                }
            });
            
            // Verifica conquistas de atividades
            CONQUISTAS.atividades.forEach(c => {
                if (progresso.atividades_concluidas < c.requisito && 
                    progresso.atividades_concluidas >= c.requisito * 0.7) {
                    proximas++;
                }
            });
            
            // Verifica conquistas de jogos
            CONQUISTAS.jogos.forEach(c => {
                if (progresso.jogos_concluidos < c.requisito && 
                    progresso.jogos_concluidos >= c.requisito * 0.7) {
                    proximas++;
                }
            });

            // Atualiza os cards de estat√≠sticas
            const statsCards = document.querySelectorAll('.conquistas-stats .stat-card');
            if (statsCards.length >= 4) {
                statsCards[0].querySelector('.stat-number').textContent = desbloqueadas;
                statsCards[1].querySelector('.stat-number').textContent = bloqueadas;
                statsCards[2].querySelector('.stat-number').textContent = percentualCompleto + '%';
                statsCards[3].querySelector('.stat-number').textContent = proximas;
            }
        }

        // ===============================
        // CARREGA PROGRESSO DO USU√ÅRIO
        // ===============================
        async function carregarProgresso() {
            const usuarioId = localStorage.getItem('usuarioId');
            if (!usuarioId) {
                console.error('‚ùå Usu√°rio n√£o logado');
                return;
            }

            const idConvertido = Number(usuarioId);
            
            const { data, error } = await supabase
                .from('progresso')
                .select('*')
                .eq('user_id', idConvertido)
                .single();

            if (error) {
                console.error('‚ùå Erro ao carregar progresso:', error.message);
                return;
            }

            console.log('üìä Progresso carregado:', data);
            atualizarConquistas(data);
        }

        // ===============================
        // EXECUTA AO CARREGAR A P√ÅGINA
        // ===============================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina de conquistas carregada');
            window.history.scrollRestoration = 'manual';
            window.scrollTo(0, 0);
            carregarProgresso();
        });
    </script>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification">
        Todas as Suas Conquistas! üéâ
    </div>

    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="home.html" class="logo">LeituraKids</a>
            <nav>
                <div class="dropdown">
                    <button onclick="toggleMenu()" class="btn btn-gray">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <div id="menuDropdown" class="dropdown-content">
                        <a href="index.html#contact">Ajuda</a>
                        <a href="index.html">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Menu Vertical -->
    <nav class="side-nav">
        <div class="side-nav-item active" onclick="window.location.href='home.html'" title="Perfil">
            <img src="img/casa.png" alt="Perfil">
        </div>
        <div class="side-nav-item" onclick="window.location.href='aulas.html'" title="Aulas">
            <img src="img/livro.png" alt="Aulas">
        </div>
        <div class="side-nav-item" onclick="window.location.href='atividades.html'" title="Atividades">
            <img src="img/lapis.png" alt="Atividades">
        </div>
        <div class="side-nav-item" onclick="window.location.href='mapa.html'" title="Mapa">
            <img src="img/mapa.png" alt="Mapa">
        </div>
        <div class="side-nav-item" onclick="window.location.href='jogos.html'" title="Jogos">
            <img src="img/controle.png" alt="Jogos">
        </div>
    </nav>

    <!-- Conte√∫do Conquistas -->
    <main class="main-content">
        <a href="home.html"><button class="back-button">Voltar</button></a>
        
        <!-- Cabe√ßalho das Conquistas -->
        <div class="conquistas-header">
            <h1>üèÜ Suas Conquistas üèÜ</h1>
            <p>Continue aprendendo e colete todas as medalhas especiais!</p>
        </div>

        <!-- Estat√≠sticas das Conquistas -->
        <div class="conquistas-stats">
            <div class="stat-card">
                <div class="stat-icon icon"><img src="img/medalha.png" alt="Conquistadas"/></div>
                <div class="stat-number">0</div>
                <div class="stat-label">Conquistadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon"><img src="img/cadeado.png" alt="Bloqueadas"/></div>
                <div class="stat-number">12</div>
                <div class="stat-label">Bloqueadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon"><img src="img/estrela.png" alt="Completado"/></div>
                <div class="stat-number">0%</div>
                <div class="stat-label">Completado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon"><img src="img/alvo.png" alt="Pr√≥ximas"/></div>
                <div class="stat-number">0</div>
                <div class="stat-label">Pr√≥ximas</div>
            </div>
        </div>

        <!-- Categorias de Conquistas -->
        <div class="badges-categories">
            <!-- Conquistas de Pontos -->
            <div class="category-section">
                <h2 class="category-title">
                    üî§ Conquistas do Alfabeto
                </h2>
                <p class="category-description">Medalhas por aprender as letras e seus sons</p>
                <div class="badges-grid">
                    <!-- Conquistas ser√£o inseridas dinamicamente aqui -->
                </div>
            </div>

            <!-- Conquistas de Atividades -->
            <div class="category-section">
                <h2 class="category-title">
                    üìñ Conquistas das tarefas
                </h2>
                <p class="category-description">Medalhas por realizar atividades</p>
                <div class="badges-grid">
                    <!-- Conquistas ser√£o inseridas dinamicamente aqui -->
                </div>
            </div>

            <!-- Conquistas de Jogos -->
            <div class="category-section">
                <h2 class="category-title">
                    üéÆ Conquistas dos Jogos
                </h2>
                <p class="category-description">Medalhas por jogar e se divertir aprendendo</p>
                <div class="badges-grid">
                    <!-- Conquistas ser√£o inseridas dinamicamente aqui -->
                </div>
            </div>
        </div>
    </main>
    
    <a href="#" class="ancora">
        <span class="material-symbols-outlined">anchor</span>
    </a>
</body>
</html>