<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/png" href="img/ancora.png">
    <link rel="stylesheet" type="text/css" href="style_mapa.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Leitura Kids - Mapa</title>
    <style>
        /* Estilos para os estados dos nÃ­veis */
        .node-completed {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
        }

        .node-current {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        .node-locked {
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
            opacity: 0.7;
        }

        .node-label {
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .node-points {
            font-size: 0.85rem;
            color: #2ecc71;
            font-weight: bold;
            margin-top: 6px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            display: block;
        }

        .node-locked-points {
            font-size: 0.85rem;
            color: #cd853f;
            font-weight: bold;
            margin-top: 6px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 30px rgba(243, 156, 18, 0.6);
            }
        }

        /* Loading spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            animation: spin 1s linear infinite;
            z-index: 9999;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>

<body>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://dnphjoqmkvnjueiwjayu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRucGhqb3Fta3ZuanVlaXdqYXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjE3ODEsImV4cCI6MjA3MzUzNzc4MX0.r8-M9EZg73sIrwESfd61hyGITsEwv_TJFZOBYeXk3d8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===============================
        // SISTEMA DE NÃVEIS DO MAPA
        // ===============================
        const NIVEIS_MAPA = [
            {
                id: 1,
                nome: 'Porto Inicial',
                descricao: 'Sua jornada comeÃ§a aqui',
                pontosMinimos: 0,
                icone: 'navio.png',
                link: 'home.html'
            },
            {
                id: 2,
                nome: 'Ilha das Letras',
                descricao: 'Descubra o alfabeto mÃ¡gico',
                pontosMinimos: 100,
                icone: 'ilha.png',
                link: 'aulas.html'
            },
            {
                id: 3,
                nome: 'BaÃ­a dos Piratas',
                descricao: 'Pratique suas habilidades',
                pontosMinimos: 500,
                icone: 'pirata-bandeira.png',
                link: 'atividades.html'
            },
            {
                id: 4,
                nome: 'Caverna do Tesouro',
                descricao: 'Jogos e diversÃ£o',
                pontosMinimos: 1000,
                icone: 'bau.png',
                link: 'jogos.html'
            },
            {
                id: 5,
                nome: 'Navio Fantasma',
                descricao: 'Desafios assombrados',
                pontosMinimos: 2000,
                icone: 'ðŸ‘»',
                link: '#'
            },
            {
                id: 6,
                nome: 'Ilha do CapitÃ£o',
                descricao: 'Teste final de perÃ­cia',
                pontosMinimos: 3000,
                icone: 'âš“',
                link: '#'
            },
            {
                id: 7,
                nome: 'Reino dos Leitores',
                descricao: 'O tesouro supremo',
                pontosMinimos: 5000,
                icone: 'coroa.png',
                link: '#'
            }
        ];

        // ===============================
        // CARREGA PROGRESSO DO USUÃRIO
        // ===============================
        async function carregarProgressoMapa() {
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'loading-spinner';
            loadingSpinner.textContent = 'âš“';
            document.body.appendChild(loadingSpinner);

            const usuarioId = localStorage.getItem('usuarioId');
            console.log('ðŸ—ºï¸ Carregando progresso do mapa para usuÃ¡rio:', usuarioId);
            
            if (!usuarioId) {
                console.error('âŒ Nenhum usuÃ¡rio logado');
                loadingSpinner.remove();
                showNotification('Erro: FaÃ§a login primeiro!');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            const idConvertido = Number(usuarioId);
            
            try {
                const { data, error } = await supabase
                    .from('progresso')
                    .select('pontos')
                    .eq('user_id', idConvertido)
                    .single();

                if (error) {
                    console.error('âŒ Erro ao buscar progresso:', error.message);
                    loadingSpinner.remove();
                    return;
                }

                const pontos = data.pontos || 0;
                console.log('âœ… Pontos do usuÃ¡rio:', pontos);
                
                atualizarMapaNiveis(pontos);
                loadingSpinner.remove();
                
            } catch (err) {
                console.error('âŒ Erro inesperado:', err);
                loadingSpinner.remove();
            }
        }

        // ===============================
        // ATUALIZA VISUAL DO MAPA
        // ===============================
        function atualizarMapaNiveis(pontosUsuario) {
            console.log('ðŸŽ¨ Atualizando mapa com', pontosUsuario, 'pontos');

            // Encontra o nÃ­vel atual (Ãºltimo nÃ­vel desbloqueado)
            let nivelAtual = NIVEIS_MAPA[0];
            for (let i = NIVEIS_MAPA.length - 1; i >= 0; i--) {
                if (pontosUsuario >= NIVEIS_MAPA[i].pontosMinimos) {
                    nivelAtual = NIVEIS_MAPA[i];
                    break;
                }
            }

            // Atualiza cada nÃ³ do mapa
            NIVEIS_MAPA.forEach((nivel, index) => {
                const nodeNumber = index + 1;
                const nodeElement = document.querySelector(`.node-${nodeNumber}`);
                
                if (!nodeElement) {
                    console.warn(`âš ï¸ NÃ³ ${nodeNumber} nÃ£o encontrado`);
                    return;
                }

                const nodeContent = nodeElement.querySelector('.node-content');
                const nodeCircle = nodeElement.querySelector('.node-circle');
                const nodeLabel = nodeElement.querySelector('.node-label');
                const nodeProgress = nodeElement.querySelector('.node-progress');

                // Atualiza o nome do nÃ­vel
                nodeLabel.textContent = nivel.nome;

                // Determina o estado do nÃ­vel
                let estado = '';
                let progressoTexto = '';

                if (pontosUsuario >= nivel.pontosMinimos) {
                    if (nivel.id === nivelAtual.id) {
                        // NÃ­vel atual (Ãºltimo desbloqueado)
                        estado = 'node-current';
                        progressoTexto = '<div>NÃ­vel Atual!</div>';
                    } else {
                        // NÃ­vel completo
                        estado = 'node-completed';
                        progressoTexto = `<div>Completo!</div><div class="node-points">${nivel.pontosMinimos} pontos</div>`;
                    }

                    // Remove cadeado e adiciona link
                    nodeCircle.innerHTML = `<div class="icon"><img src="img/${nivel.icone}" alt="${nivel.nome}"></div>`;
                    
                    if (nivel.link !== '#') {
                        nodeContent.style.cursor = 'pointer';
                        nodeContent.onclick = () => window.location.href = nivel.link;
                    }
                } else {
                    // NÃ­vel bloqueado
                    estado = 'node-locked';
                    progressoTexto = `<div class="node-locked-points">ðŸ”’ ${nivel.pontosMinimos} pontos</div>`;
                    nodeCircle.innerHTML = 'ðŸ”’';
                    nodeContent.style.cursor = 'not-allowed';
                    nodeContent.onclick = () => {
                        showNotification(`ðŸ”’ VocÃª precisa de ${nivel.pontosMinimos} pontos!`);
                    };
                }

                // Atualiza classes e conteÃºdo
                nodeCircle.className = `node-circle ${estado}`;
                
                if (nodeProgress) {
                    nodeProgress.innerHTML = progressoTexto;
                }

                console.log(`âœ… NÃ­vel ${nivel.id} (${nivel.nome}): ${estado}`);
            });

            showNotification(`ðŸ—ºï¸ VocÃª estÃ¡ no ${nivelAtual.nome}!`);
        }

        // ===============================
        // FUNÃ‡ÃƒO DE NOTIFICAÃ‡ÃƒO
        // ===============================
        window.showNotification = function(message) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // ===============================
        // FUNÃ‡Ã•ES DO MENU
        // ===============================
        window.toggleMenu = function() {
            document.getElementById("menuDropdown").classList.toggle("show");
        }

        window.addEventListener("click", function (event) {
            if (!event.target.closest(".dropdown")) {
                const dropdown = document.getElementById("menuDropdown");
                if (dropdown) dropdown.classList.remove("show");
            }
        });

        // ===============================
        // INICIALIZAÃ‡ÃƒO
        // ===============================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ Mapa carregado, inicializando...');
            carregarProgressoMapa();
        });
    </script>

    <!-- NotificaÃ§Ã£o -->
    <div class="notification" id="notification">
        Mapa do Tesouro, Avante Marujo!
    </div>

    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="home.html" class="logo">LeituraKids</a>
            <nav>
                <div class="dropdown">
                    <button onclick="toggleMenu()" class="btn btn-gray">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <div id="menuDropdown" class="dropdown-content">
                        <a href="index.html">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Menu Vertical -->
    <nav class="side-nav">
        <div class="side-nav-item" onclick="window.location.href='home.html'" title="Perfil">
            <img src="img/casa.png" alt="Perfil">
        </div>
        <div class="side-nav-item" onclick="window.location.href='aulas.html'" title="Aulas">
            <img src="img/livro.png" alt="Aulas">
        </div>
        <div class="side-nav-item" onclick="window.location.href='atividades.html'" title="Atividades">
            <img src="img/lapis.png" alt="Atividades">
        </div>
        <div class="side-nav-item active" onclick="window.location.href='mapa.html'" title="Mapa">
            <img src="img/mapa.png" alt="Mapa">
        </div>
        <div class="side-nav-item" onclick="window.location.href='jogos.html'" title="Jogos">
            <img src="img/controle.png" alt="Jogos">
        </div>
    </nav>

    <!-- Elementos decorativos -->
    <div class="decorative-elements">
        <div class="compass">ðŸ§­</div>
        <div class="treasure-marks mark-1">âœ—</div>
        <div class="treasure-marks mark-2">âœ—</div>
        <div class="treasure-marks mark-3">âœ—</div>
        <div class="treasure-marks mark-4">âœ—</div>
    </div>

    <!-- ConteÃºdo Principal -->
    <main class="main-content">
        <div class="map-header">
            <h1 class="map-title">
                <div class="icon"><img src="img/mapa.png" alt="Mapa do Tesouro" /></div>
                Mapa da Aventura Pirata
            </h1>
            <p class="map-subtitle">Navegue pelos mares do conhecimento e colete todos os tesouros!</p>
        </div>

        <div class="adventure-map">
            <!-- Rio serpenteante de fundo -->
            <svg class="river" viewBox="0 0 800 1000">
                <path class="river-path" d="M -50 200 Q 150 180 300 220 Q 450 260 600 200 Q 750 140 850 180 
                     Q 700 240 550 280 Q 400 320 250 360 Q 100 400 -50 380
                     Q 150 420 300 460 Q 450 500 600 540 Q 750 580 850 620
                     Q 700 660 550 700 Q 400 740 250 780 Q 100 820 -50 800" />
            </svg>

            <!-- Lagos -->
            <div class="lake lake-1"></div>
            <div class="lake lake-2"></div>

            <!-- VegetaÃ§Ã£o - Coqueiros -->
            <div class="vegetation palm-tree palm-1">ðŸŒ´</div>
            <div class="vegetation palm-tree palm-2">ðŸŒ´</div>
            <div class="vegetation palm-tree palm-3">ðŸŒ´</div>
            <div class="vegetation palm-tree palm-4">ðŸŒ´</div>
            <div class="vegetation palm-tree palm-5">ðŸŒ´</div>

            <!-- VegetaÃ§Ã£o - Ãrvores -->
            <div class="vegetation tree tree-1">ðŸŒ³</div>
            <div class="vegetation tree tree-2">ðŸŒ³</div>
            <div class="vegetation tree tree-3">ðŸŒ³</div>
            <div class="vegetation tree tree-4">ðŸŒ³</div>
            <div class="vegetation tree tree-5">ðŸŒ³</div>
            <div class="vegetation tree tree-6">ðŸŒ³</div>

            <!-- VegetaÃ§Ã£o - Arbustos -->
            <div class="vegetation bush bush-1">ðŸŒ¿</div>
            <div class="vegetation bush bush-2">ðŸŒ¿</div>
            <div class="vegetation bush bush-3">ðŸŒ¿</div>
            <div class="vegetation bush bush-4">ðŸŒ¿</div>

            <!-- SVG Path Tracejado Vermelho -->
            <svg class="treasure-path" viewBox="0 0 800 1000">
                <path class="path-stroke"
                    d="M 400 70 Q 200 150 200 220 Q 200 290 600 370 Q 160 450 160 520 Q 160 590 640 670 Q 280 750 280 820 Q 280 890 400 970" />
            </svg>

            <!-- NÃ­vel 1 - Porto Inicial -->
            <div class="map-node node-1">
                <div class="node-content">
                    <div class="node-circle">
                        <div class="icon"><img src="img/navio.png" alt="Porto Inicial"></div>
                    </div>
                    <div class="node-label">Porto Inicial</div>
                </div>
            </div>

            <!-- NÃ­vel 2 - Ilha das Letras -->
            <div class="map-node node-2">
                <div class="node-content">
                    <div class="node-circle">
                        <div class="icon"><img src="img/ilha.png" alt="Ilha das Letras"></div>
                    </div>
                    <div class="node-label">Ilha das Letras</div>
                    <div class="node-progress">Carregando...</div>
                </div>
            </div>

            <!-- NÃ­vel 3 - BaÃ­a dos Piratas -->
            <div class="map-node node-3">
                <div class="node-content">
                    <div class="node-circle">
                        <div class="icon"><img src="img/pirata-bandeira.png" alt="BaÃ­a dos Piratas"></div>
                    </div>
                    <div class="node-label">BaÃ­a dos Piratas</div>
                    <div class="node-progress">Carregando...</div>
                </div>
            </div>

            <!-- NÃ­vel 4 - Caverna do Tesouro -->
            <div class="map-node node-4">
                <div class="node-content">
                    <div class="node-circle">
                        <div class="icon"><img src="img/bau.png" alt="Caverna do Tesouro"></div>
                    </div>
                    <div class="node-label">Caverna do Tesouro</div>
                    <div class="node-progress">Carregando...</div>
                </div>
            </div>

            <!-- NÃ­vel 5 - Navio Fantasma -->
            <div class="map-node node-5">
                <div class="node-content">
                    <div class="node-circle node-locked">
                        ðŸ”’
                    </div>
                    <div class="node-label">Navio Fantasma</div>
                    <div class="node-progress"></div>
                </div>
            </div>

            <!-- NÃ­vel 6 - Ilha do CapitÃ£o -->
            <div class="map-node node-6">
                <div class="node-content">
                    <div class="node-circle node-locked">
                        ðŸ”’
                    </div>
                    <div class="node-label">Ilha do CapitÃ£o</div>
                    <div class="node-progress"></div>
                </div>
            </div>

            <!-- Boss Final - Reino dos Leitores -->
            <div class="map-node node-7">
                <div class="node-content">
                    <div class="node-circle node-locked" style="width: 120px; height: 120px; font-size: 3rem;">
                        ðŸ”’
                    </div>
                    <div class="node-label">Reino dos Leitores</div>
                    <div class="node-progress"></div>
                </div>
            </div>

            <!-- Papagaio -->
            <div class="papagaio">
                <img src="img/papagaio.png" alt="papagaio">
            </div>
            <!-- Pirata -->
            <div class="pirata">
                <img src="img/pirata.png" alt="pirata">
            </div>
        </div>
    </main>
    
    <a href="#" class="ancora">
        <span class="material-symbols-outlined">anchor</span>
    </a>
</body>

</html>